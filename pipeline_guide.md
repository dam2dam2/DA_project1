# 통합 데이터 전처리 파이프라인 가이드 (`rebuild_pipeline.py`)

이 문서는 `data/origin_data` 폴더의 원본 엑셀 파일들을 통합하고 익명화하여 분석용 `preprocessed_data_new.csv`를 생성하는 과정을 설명합니다.

## 1. 전처리 실행 및 통합 방법
- **환경**: `/Users/dmjeong/innercircle/.venv` (Python 3.8+)
- **명령어**:
  ```bash
  /Users/dmjeong/innercircle/.venv/bin/python /Users/dmjeong/innercircle/DA_project1/rebuild_pipeline.py
  ```
- **수행 과정**:
  1. `data/origin_data/*.xlsx` 파일 수집 및 병합.
  2. 고객 연락처 및 수령인 연락처 익명화 (`ANON_XXXXX`).
  3. `UID` 생성: `상품코드 + 상품명 + 판매단가`의 조합으로 고유 식별자 부여.
  4. 파생 필드 생성 및 수치 정규화 (기존 `run_pipeline.py` 로직 포함).

---

## 2. 상세 데이터 변환 로직 (Pure Logic)

스크립트는 외부 참조 없이 원본 `xlsx` 파일의 텍스트와 수치를 분석하여 다음 과정을 수행합니다.

### 2.1 칼럼 매핑 및 기초 정밀화
| 원본 칼럼명 (xlsx) | 변환 칼럼명 (csv) | 설명 |
| :--- | :--- | :--- |
| `결제금액(상품별)` | `결제금액` | 상품별 결제 금액 (수치형 변환) |
| `주문취소 금액(상품별)` | `주문취소 금액` | 취소된 금액 (수치형 변환) |
| `단가` | `판매단가` | 상품 개당 판매 가격 |
| `공급가` | `공급단가` | 상품 개당 공급 가격 |
| - | `실결제 금액` | `결제금액` - `주문취소 금액` |
| - | `주문-취소 수량` | `주문수량` - `취소수량` |
| - | `취소여부` | `취소수량` > 0 이면 'Y', 아니면 'N' |

### 2.2 핵심 파생 필드 생성
1. **재구매 횟수**
   - 동일한 `주문자연락처`를 가진 데이터 중 **고유한 주문 날짜(Day)**의 수를 카운트합니다.
   - 공식: `(고유 주문 날짜 수) - 1` (최초 구매는 0회 재구매로 표기)

2. **광역지역 및 정식 명칭**
   - **1순위**: `우편번호` 앞 2자리를 기반으로 17개 광역지자체 매핑.
   - **2순위**: `주소` 텍스트의 시작 단어 혹은 포함 단어로 판별.
   - **정규화**: '경기' -> '경기도', '서울' -> '서울특별시' 등 정식 행정구역 명칭 부여.

3. **텍스트 분석 기반 분류 (상품명 + 옵션)**
   - **품종**: '감귤', '황금향', '고구마', '딸기' 등 키워드 추출. 여러 품종 포함 시 쉼표로 구분.
   - **감귤 세부**: 품종이 '감귤'인 경우 '타이벡', '유라실생', '조생', '하우스' 등 세부 공법/시기 분류.
   - **과수 크기**: '소과', '로얄과', '혼합' 등 크기 정보 추출.
   - **무게(kg) 추출**: 
     - Regex(`(\d+(\.\d+)?)\s*(kg|KG)`)를 사용.
     - `4.5kg+4.5kg`와 같은 형태는 합산(9.0kg)하여 처리.
     - 단, 괄호 안의 메모(예: 상자무게 포함 10kg)는 실제 내용물 무게 산출 시 제외하도록 설계.

4. **비즈니스 목적 분류**
   - **목적 (선물/개인소비)**:
     - `주문자명`과 `수령인명`의 공백을 제거하고 비교하여 다를 경우 '선물'로 분류.
     - 상품명에 '선물' 키워드가 포함된 경우에도 '선물'로 분류.
   - **선물세트_여부**: 텍스트에 '선물세트', '선물용' 키워드가 명시된 경우만 '선물세트'로 표시.

### 2.3 그룹화 및 구간화
- **무게 구분**: `<3kg`, `3-5kg`, `5-10kg`, `>10kg` 구간화.
- **가격대**: `실결제 금액` 기준 (1만원 이하, 1~3만원, 3~5만원, 5~10만원, 10만원 초반).
- **상품성등급**: '프리미엄', '명품', '블랙라벨', '타이벡' 등 고품질 키워드 포함 시 '프리미엄' 분류.

---

## 3. 유지보수 및 업데이트 가이드

새로운 상품이나 이벤트가 추가되어 전처리 로직을 수정해야 할 경우 다음 규칙을 따릅니다.

### 3.1 키워드 추가 (예: 새로운 품종 추가)
- `run_pipeline.py` 내의 `parse_derived_fields` 함수에서 해당 리스트를 업데이트합니다.
```python
# 예: 샤인머스캣 추가 시
if "샤인머스캣" in full_text: category_list.append("샤인머스캣")
```

### 3.2 분류 기준 수정 (예: 가격대 구간 변경)
- `classify_price` 함수 내의 조건문 수치를 수정합니다.

### 3.3 주의사항
- **데이터 타입 유지**: 수치 데이터는 항상 `.astype(int)` 혹은 `.astype(float)`로 명확히 지정하여 기존 시각화 도구(Dashboard)와 호환성을 유지해야 합니다.
- **칼럼 순서**: `target_columns` 리스트의 순서를 변경하지 마십시오. CSV의 열 순서가 바뀌면 후속 분석 스크립트에서 오류가 발생할 수 있습니다.

---

## 4. 로직 일관성 검증 (Self-Verification)
스크립트를 수정한 후에는 반드시 다음 사항을 확인하십시오.
1. 기존 데이터와 행(Row) 수가 일치하는지 (`9144`건 기준).
2. `재구매 횟수`가 0보다 큰 데이터가 존재하는지 (재구매 로직 작동 여부).
3. `광역지역`에 NaN 혹은 빈 값이 최소화되었는지.
